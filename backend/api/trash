from fastapi import APIRouter,Depends, HTTPException
import bcrypt

#
#from enum import Enum
#
router=APIRouter(prefix="/users", tags=["users"])

usuarios = []


class kind_events(Enum):
    bautizo = 'Bautizo'
    confirm = 'Confirmacion'
    comunion = 'Primera Comunion'
    matrimonio = "Matrimonio"
    quince = "XV Años"


class User(BaseModel):
    nombres: str
    apellidos: str
    correo: EmailStr
    contra: str
    es_admin: Optional[int] = 0


class RestorePassword(BaseModel):
    correo: EmailStr
    new_password: str



class UserLogin(BaseModel):
    correo: EmailStr
    contra: str


def checkpswd(password: str, hashpswd: str):
    return bcrypt.checkpw(password.encode(), hashpswd)


def hashing(password: str):
    pswd = bcrypt.hashpw(password.encode(), bcrypt.gensalt(rounds=12))
    print(pswd)
    return pswd


@router.post("/create_user")
def Create_user(user_post: UserRegister):
    # for i in usuarios:
    #    if i.correo == user_post.correo:
    #       raise HTTPException(status_code=404,detail="usuario duplicado")

    # if user_post.contra!=user_post.confirm_pswd:
    #   raise HTTPException(status_code=404,detail="La contraseña no coincide")

    user_post.contra = hashing(user_post.contra)
    usuarios.append(user_post)
    return {'user': user_post}


@app.post("/login")  # meterle tokens
def login(log_user: UserLogin):
    for i in usuarios:
        if i.correo == log_user.correo and checkpswd(log_user.contra, i.contra):
            return {"login": "True"}
    raise HTTPException(status_code=404, detail="No se encontro al usuario")


@app.post("/restore_password")
def restore_password(chng_user: RestorePassword):
    print("1")
    for i in usuarios:
        if i.correo == chng_user.correo:
            i.contra = chng_user.new_password
            return {"message": i.correo + " contraseña cambiada"}
    raise HTTPException(status_code=404, detail="No se encontro al usuario")


@app.get("/see_users")
def See_users():
    return {'users': usuarios}
