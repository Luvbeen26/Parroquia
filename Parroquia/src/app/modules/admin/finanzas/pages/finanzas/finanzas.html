<main class="Contenedor flex-column">
  <div class="header-section flex">
    <h1 class="page-title">
      Historial de Finanzas
    </h1>
    <button class="button btn-primary flex" (click)="abrirModalNuevoGasto()">
      <mat-icon>add_circle</mat-icon>
      Agregar un Registro
    </button>
  </div>

  
  <div class="filters-summary-row">
    <div class="filters-container flex">
      <div class="filter-group">
        <label class="filter-label">Fecha Inicio</label>
        <input type="date" class="Input filter-input" (change)="aplicarFiltros($event,1)">
      </div>

      <div class="filter-group">
        <label class="filter-label">Fecha Fin</label>
        <input type="date" class="Input filter-input" (change)="aplicarFiltros($event,2)">
      </div>

      <div class="filter-group">
        <label class="filter-label">Categoría</label>
        <select class="Input filter-input" (change)="aplicarFiltros($event,3)">
            <option value="">Todas</option>
            <option value="1">Operativo</option>
            <option value="2">Personal</option>
            <option value="3">Mantenimiento</option>
            <option value="4">Administrativo</option>
            <option value="5">Donaciones</option>
            <option value="6">Planificación de eventos</option>
            <option value="7">Venta</option>
        </select>
      </div>

      <button class="btn-filter" (click)="limpiarFiltros()">
        <mat-icon>filter_alt_off</mat-icon>
        Limpiar
      </button>
    </div>
  </div>

  <div class="table-container">
    <table class="finanzas-table">
      <thead>
        <tr>
          <th>Descripción</th>
          <th>Fecha y Hora</th>
          <th>Categoría</th>
          <th>Monto</th>
          
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        @let lista = (finanzas$ | async);
        @for (f of lista; track $index) {
          <tr>
            <td class="descripcion-cell">
              <div class="descripcion-content">
                <span class="descripcion-text">{{ f.descripcion }}</span>
              </div>
            </td>
            
            <td class="fecha-cell">
              <div class="fecha-content">
                <mat-icon class="fecha-icon">calendar_today</mat-icon>
                <span>{{ f.fecha | date:'dd-MM-yyyy HH:mm' }}</span>
              </div>
            </td>
            
            <td>
              <span class="categoria-badge" [ngClass]="'categoria-' + f.categoria">
                {{ f.categoria }}
              </span>
            </td>
            
          
            <td class="monto-cell">
              <span class="monto" [class.Ingreso]="f.tipo_categoria === 'Ingreso'" [class.Gasto]="f.tipo_categoria === 'Gasto'">
                {{ f.monto | currency:'MXN' }}
              </span>
            </td>
            
            <td class="actions-cell">
              <button class="action-btn edit-btn" matTooltip="Editar" (click)="editarModal(f.id_transaccion,f.monto,f.descripcion,f.id_categoria,f.evidencia)">
                <mat-icon>edit</mat-icon>
              </button>
              <button class="action-btn delete-btn" matTooltip="Eliminar" (click)="delRegistro(f.id_transaccion)">
                <mat-icon>delete</mat-icon>
              </button>
            
              @if (f.evidencia != null) {
                <button class="btn-evidencia" (click)="verEvidencia(f.evidencia)">
                  <mat-icon>visibility</mat-icon>
                </button>
              }
            
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="7" class="empty-state">
              <mat-icon>receipt_long</mat-icon>
              <p>No hay registros financieros</p>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <div class="pagination flex">
    <button class="page-btn" [disabled]="currentPage === 1" (click)="previousPage()">
      <mat-icon>chevron_left</mat-icon>
    </button>
    
    @for (page of pages; track page) {
      <button class="page-btn" [class.active]="currentPage === page" (click)="goToPage(page)">
        {{ page }}
      </button>
    }
    
    <button class="page-btn" [disabled]="currentPage === totalPages" (click)="nextPage()">
      <mat-icon>chevron_right</mat-icon>
    </button>
  </div>
</main>


<app-modalcomponent
  [isOpen]="isModalOpen"
  [title]="title"
  [showFooter]="true"
  [showConfirmButton]='true'
  [disableConfirm]="this.formFinanzas.invalid"
  (onClose)="closeModal()"
  (onConfirmClick)="modalOperation === 'Add' ? AddRegistro() : editarRegistro()">
    @if(modalOperation == "Add" || modalOperation == "Edit"){
      <form [formGroup]="formFinanzas" class="form-finanzas flex-column">
        
        <div class="campo flex-column">
          <h4>Monto</h4>
          <input type="number" formControlName="monto" class="Input" placeholder="0.00" step="0.01" min="0">
          @if (this.formFinanzas.get('monto')?.hasError('required') && this.formFinanzas.get('monto')?.touched) {
            <p class="error">Ingrese un monto</p>
          }
        </div>

        <div class="campo flex-column">
          <h4>Categoría</h4>
          <select formControlName="id_categoria" class="Input">
            <option value="">Seleccione una categoría</option>
            <option value="1">Operativo</option>
            <option value="2">Personal</option>
            <option value="3">Mantenimiento</option>
            <option value="4">Administrativo</option>
            <option value="5">Donaciones</option>
            <option value="6">Planificacion de Eventos</option>
            <option value="7">Venta</option>
          </select>
          @if (this.formFinanzas.get('id_categoria')?.hasError('required') && this.formFinanzas.get('id_categoria')?.touched) {
            <p class="error">Seleccione una categoría</p>
          }
        </div>

        <div class="campo flex-column">
          <h4>Descripción</h4>
          <textarea formControlName="descripcion" class="Input textarea" 
            placeholder="Descripción del ingreso/egreso" rows="3" maxlength="60"></textarea>
          @if (this.formFinanzas.get('descripcion')?.hasError('required') && this.formFinanzas.get('descripcion')?.touched) {
            <p class="error">Ingrese una descripción</p>
          }
        </div>

        @if(this.formFinanzas.get('id_categoria')?.value>=1 && this.formFinanzas.get('id_categoria')?.value<5){
          <div class="campo flex-column">
            <h4>Comprobante</h4>
            <div class="file-upload-container">
              <label [for]="'comprobante'" class="two-button flex">
                <mat-icon>insert_drive_file</mat-icon>
                Subir Archivo
              </label>
              <input type="file" [id]="'comprobante'" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileSelected($event)" 
                hidden>
              
              @if(selectedFileName) {
                <span class="filename">{{ selectedFileName }}</span>
              }
            </div>
            <p class="file-info">Formatos permitidos: PDF, JPG, PNG (Máx. 5MB)</p>
          </div>
        }

      </form>
    }

</app-modalcomponent>


<app-modal-file [content]="modalContent" [isOpen]="isModalOpen2" (closeModal)="closeModal()">

</app-modal-file>